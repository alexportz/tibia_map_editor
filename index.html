<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Editor - Tibia Javascript</title>

    <style type="text/css">
        body {
            background:#333;
            margin:0;
            padding:0;
            overflow: hidden;
        }
    </style>

</head>
<body>
    <canvas id="mapa"></canvas>


    <script>
        //DEFINE AS VARIAVEIS DO CANVAS
        const cnv = document.querySelector("#mapa");
        const ctx = cnv.getContext("2d");

        //DEFINE O TAMANHO DO CANVAS
        cnv.width = innerWidth;
        cnv.height = innerHeight;

        //DEFINIÇÕES INICIAIS DO PROJETO
        //Definições de Tela
        let screenSizeW = innerWidth;
        let screenSizeH = innerHeight;
        //Definições do Sqm
        let defaultSqmPositionX = 50;
        let defaultSqmPositionY = 50;
        let defaultSqmSizeW = 50;
        let defaultSqmSizeH = 50;
        //Definições do Mapa
        let totalSqmX = 20;
        let totalSqmY = 10;
        let defaultMapaPositionX = 150;
        let defaultMapaPositionY = 50;
        let defaultMapaSizeW = totalSqmX * defaultSqmPositionX;
        let defaultMapaSizeH = totalSqmY * defaultSqmPositionY;

        
        //////////////////////CLASSES////////////////////////////////
        class Mouse {
            constructor(){
                this.posX = 0;
                this.posY = 0;
                this.clicado = false;
                this.movendo = false;
            }
        }

        class Sqm {
            constructor( context, positionX, positionY, sizeWidth, sizeHeight){
                this.posX = positionX;
                this.posY = positionY;
                this.sizeW = sizeWidth;
                this.sizeH = sizeHeight;
                this.ctx = context;
                this.actualSprite = null;
                this.actualColor = null;
            }
            render(){
                this.ctx.fillRect(this.posX,this.posY,this.sizeW,this.sizeH);
            }
        }

        class Mapa {
            constructor(context, positionX, positionY, sizeWidth, sizeHeight, maxSqmX, maxSqmY){
                this.posX = positionX;
                this.posY = positionY;
                this.sizeW = sizeWidth;
                this.sizeH = sizeHeight;
                this.maxSqmX = maxSqmX;
                this.maxSqmY = maxSqmY;
                this.sqmSizeX = sizeWidth/maxSqmX;
                this.sqmSizeY = sizeHeight/maxSqmY;
                this.ctx = context;
                this.matriz = []
            }

            render(){
                //Desenhar Grids do Mapa
                let atualPointX = 0;
                let atualPointY = 0;
                for ( let i=0; i < this.maxSqmX; i++){
                    for (let j=0; j < this.maxSqmY; j++){
                        //Desenha grids.
                        this.ctx.strokeStyle = "#000";
                        this.ctx.strokeRect( atualPointX + this.posX, atualPointY + this.posY, this.sqmSizeX, this.sqmSizeY);

                        //Incrementa valor ao posição X
                        atualPointX += this.sqmSizeX;

                        //Verifica se passou da Borda
                        if (atualPointX >= this.sizeW){
                            atualPointX = 0;
                            atualPointY += this.sqmSizeY;
                        }
                    }
                }

                //Desenhar borda externa
                this.ctx.strokeStyle = "#CCC";
                this.ctx.strokeRect( this.posX, this.posY, this.sizeW, this.sizeH);
            }
        }

        //////////////////////FUNÇÔES////////////////////////////////
        //Função Inicial que é chamada ao iniciar a página
        function start(){
            //Inicia o Loop
            loop();

        }

        //Função que executa a todo momento, e chama ela mesmo (loop)
        function loop(){

            //Desenha o Mapa
            mapaPrincipal.render();

            //Renderiza cada Sqm da Matrix
            mapaPrincipal.matriz.forEach( (sqm) => { sqm.render(); })

            //Chama a função novamente
            requestAnimationFrame(loop);
        }

        //Função de Desenho
        function draw(ctx,posX,posY,sizeW,sizeH){
            ctx.fillRect(posX,posY,sizeW,sizeH);
        }

        //Função que Retorna posição exata do SQM
        function retornarSqmExato(mouseX, mouseY, mapa){
            let colunaClicada = Math.floor( (mouseX - mapa.posX) / mapa.sqmSizeX);
            let linhaClicada = Math.floor( (mouseY - mapa.posY) / mapa.sqmSizeY);

            //Verifica se o clique está em área permitida
            if (colunaClicada < 0 || colunaClicada >= mapa.maxSqmX || linhaClicada < 0 || linhaClicada >= mapa.maxSqmY){
                return { erro: true}
            }

            //Retorna Coluna e Linha do clique
            return { x: colunaClicada, y: linhaClicada, erro:false }

            //console.log(colunaClicada, linhaClicada);
        }


        //Função Mouse - Movimentação
        addEventListener("mousemove", function(e){
            mouse.posX = e.clientX;
            mouse.posY = e.clientY;
            //console.log(mouse.posX, mouse.posY);
        })
        //Função Mouse - Clique
        addEventListener("mousedown", function(e){
            mouse.clicado = true;

            //Pegar o ponto do SQM Exato
            let sqmPosition = retornarSqmExato( mouse.posX, mouse.posY , mapaPrincipal); 

            //Valida o clique antes de Instanciar o SQM
            if ( sqmPosition.erro == true) {
                return;
            }
            
            //Instancia um novo SQM na posição clicada
            let sqmAtual = new Sqm(
                ctx,
                sqmPosition.x * defaultSqmSizeW + mapaPrincipal.posX,
                sqmPosition.y * defaultSqmSizeH + mapaPrincipal.posY,
                defaultSqmSizeW,
                defaultSqmSizeH
            );

            //Adicionar o Sqm Instanciado à Matrix do Mapa
            mapaPrincipal.matriz.push(sqmAtual);
            
            //console.log(mapaPrincipal.matriz);
            //console.log("Clicou");
        })
        //Função Mouse - Soltou Clique
        addEventListener("mouseup", function(e){
            mouse.clicado = false;
            //console.log("Soltou");
        })

        

        //Instâncias
        let mapaPrincipal = new Mapa(ctx, defaultMapaPositionX, defaultMapaPositionY, defaultMapaSizeW, defaultMapaSizeH, totalSqmX, totalSqmY);
        let mouse = new Mouse();

        //Inicia o carregamento geral
        start();



    </script>
</body>
</html>