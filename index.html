<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Editor - Tibia Javascript</title>

    <style type="text/css">
        body {
            background:#333;
            margin:0;
            padding:0;
            overflow: hidden;
        }
    </style>

</head>
<body>
    <canvas id="mapa"></canvas>


    <script>
        //DEFINE AS VARIAVEIS DO CANVAS
        const cnv = document.querySelector("#mapa");
        const ctx = cnv.getContext("2d");

        //DEFINE O TAMANHO DO CANVAS
        cnv.width = innerWidth;
        cnv.height = innerHeight;

        //DEFINIÇÕES INICIAIS DO PROJETO
        //Definições de Tela
        let screenSizeW = innerWidth;
        let screenSizeH = innerHeight;
        //Definições do tamanho de Sprite
        let originalSpriteX = 72;
        let originalSpriteY = 72;
        //Definições do Sqm
        let defaultSqmPositionX = 30;
        let defaultSqmPositionY = 30;
        let defaultSqmSizeW = 30;
        let defaultSqmSizeH = 30;
        //Definições do Mapa
        let totalSqmX = 50;
        let totalSqmY = 20;
        let defaultMapaPositionX = 150;
        let defaultMapaPositionY = 10;
        let defaultMapaSizeW = totalSqmX * defaultSqmPositionX;
        let defaultMapaSizeH = totalSqmY * defaultSqmPositionY;

        //Inicia o carregamento da Imagem do SpriteMap
        let spriteMap = new Image();
        spriteMap.src = "./sprites/mapa.jpg";  //72px cada SqmRenderizado

        //DEFINIÇÕES DO SPRITE
        //Define o total de SQM no Sprite carregado
        let totalDeSqmSpriteX = spriteMap.width/originalSpriteX;
        let totalDeSqmSpriteY = spriteMap.height/originalSpriteY;
        let sqmPadraoSpriteX = 4 * originalSpriteX;
        let sqmPadraoSpriteY = 1 * originalSpriteY;

        //////////////////////CLASSES////////////////////////////////
        class Mouse {
            constructor(){
                this.posX = 0;
                this.posY = 0;
                this.clicado = false;
                this.movendo = false;
            }
        }

        class Sqm {
            constructor( context, sprite, positionX, positionY, sizeWidth, sizeHeight, numeroColuna, numeroLinha,originalSpriteX,originalSpriteY, sqmPadraoSpriteX,sqmPadraoSpriteY){
                this.posX = positionX;
                this.posY = positionY;
                this.sizeW = sizeWidth;
                this.sizeH = sizeHeight;
                this.tamanhoOriginalDaSpriteX = originalSpriteX;
                this.tamanhoOriginalDaSpriteY = originalSpriteY;
                this.posicaoInicialSpriteX = sqmPadraoSpriteX;
                this.posicaoInicialSpriteY = sqmPadraoSpriteY;
                this.ctx = context;
                this.actualSprite = sprite;
                this.actualColor = "rgba(255,0,0,0.1)";
                this.coluna = numeroColuna;
                this.linha = numeroLinha;
            }
            render(){
                // this.ctx.fillStyle = this.actualColor;
                // this.ctx.fillRect(this.posX,this.posY,this.sizeW,this.sizeH);

                //Renderiza a Sprite no Sqm atual
                this.ctx.drawImage( 
                    this.actualSprite, 
                    this.posicaoInicialSpriteX, 
                    this.posicaoInicialSpriteY, 
                    this.tamanhoOriginalDaSpriteX, 
                    this.tamanhoOriginalDaSpriteY, 
                    this.posX, 
                    this.posY, 
                    this.sizeW, 
                    this.sizeH
                );

            }
        }

        class Mapa {
            constructor(context, positionX, positionY, sizeWidth, sizeHeight, maxSqmX, maxSqmY){
                this.posX = positionX;
                this.posY = positionY;
                this.sizeW = sizeWidth;
                this.sizeH = sizeHeight;
                this.maxSqmX = maxSqmX;
                this.maxSqmY = maxSqmY;
                this.sqmSizeX = sizeWidth/maxSqmX;
                this.sqmSizeY = sizeHeight/maxSqmY;
                this.ctx = context;
                this.matriz = []
            }

            render(){
                //Desenhar Grids do Mapa
                let atualPointX = 0;
                let atualPointY = 0;
                for ( let i=0; i < this.maxSqmX; i++){
                    for (let j=0; j < this.maxSqmY; j++){
                        //Desenha grids.
                        this.ctx.strokeStyle = "#000";
                        this.ctx.lineWidth = .1;
                        this.ctx.strokeRect( atualPointX + this.posX, atualPointY + this.posY, this.sqmSizeX, this.sqmSizeY);

                        //Incrementa valor ao posição X
                        atualPointX += this.sqmSizeX;

                        //Verifica se passou da Borda
                        if (atualPointX >= this.sizeW){
                            atualPointX = 0;
                            atualPointY += this.sqmSizeY;
                        }
                    }
                }

                //Desenhar borda externa
                this.ctx.strokeStyle = "#CCC";
                this.ctx.strokeRect( this.posX, this.posY, this.sizeW, this.sizeH);
            }
        }

        //////////////////////FUNÇÔES////////////////////////////////
        //Função Inicial que é chamada ao iniciar a página
        function start(){
            //Inicia o Loop
            loop();

            //Instancia todos os SQMS
            instanciaTodosSqms(totalSqmX, totalSqmY);
        }

        //Função que executa a todo momento, e chama ela mesmo (loop)
        function loop(){

            //Desenha o Mapa
            mapaPrincipal.render();

            //Renderiza cada Sqm da Matrix
            mapaPrincipal.matriz.forEach( (sqm) => { sqm.render(); })

            //Chama a função novamente
            requestAnimationFrame(loop);
        }

        //Função que Retorna posição exata do SQM
        function retornarSqmExato(mouseX, mouseY, mapa){
            let colunaClicada = Math.floor( (mouseX - mapa.posX) / mapa.sqmSizeX);
            let linhaClicada = Math.floor( (mouseY - mapa.posY) / mapa.sqmSizeY);

            //Verifica se o clique está em área permitida
            if (colunaClicada < 0 || colunaClicada >= mapa.maxSqmX || linhaClicada < 0 || linhaClicada >= mapa.maxSqmY){
                return { erro: true}
            }

            //Retorna Coluna e Linha do clique
            return { x: colunaClicada, y: linhaClicada, erro:false }

            //console.log(colunaClicada, linhaClicada);
        }

        //Função que Instancia os SQMs
        function instanciaTodosSqms(totalSqmX, totalSqmY){
            
            //Variaveis contadoras temporarias
            let sqmColunaX = 0;
            let sqmColunaY = 0;
            //Inicia o Loop
            for (let i=0; i < totalSqmY; i++){
                for(let j=0; j < totalSqmX; j++){
                   

                    //Instancia um novo SQM na posição clicada
                    let sqmAtual = new Sqm(
                        ctx,
                        spriteMap,
                        sqmColunaX * defaultSqmSizeW + mapaPrincipal.posX,
                        sqmColunaY * defaultSqmSizeH + mapaPrincipal.posY,
                        defaultSqmSizeW,
                        defaultSqmSizeH,
                        sqmColunaX,
                        sqmColunaY,
                        originalSpriteX,
                        originalSpriteY,
                        sqmPadraoSpriteX,
                        sqmPadraoSpriteY
                    );

                    //Incrementa o nro da Coluna
                    sqmColunaX++;

                    //Verificar se passou o Limite do Mapa
                    if (sqmColunaX >= totalSqmX ){
                        sqmColunaX = 0;
                        sqmColunaY++;
                    }

                    //Adicionar o Sqm Instanciado à Matrix do Mapa
                    mapaPrincipal.matriz.push(sqmAtual);
                    console.log("Adicionou o SQM")

                }
            }
        }

        //Função - Editar SQMS
        function editarSqms(){

            //Pegar o ponto do SQM Exato
            let sqmPosition = retornarSqmExato( mouse.posX, mouse.posY , mapaPrincipal);
            //console.log ( sqmPosition.x, sqmPosition.y);

            //Valida o clique antes de Instanciar o SQM
            if ( sqmPosition.erro == true) {
                return;
            }

            //Buscar o Objeto dentro da Lista
            let objetoAtual = mapaPrincipal.matriz.find( sqm => sqm.coluna === sqmPosition.x && sqm.linha === sqmPosition.y);
            
            //Altera a cor do SQM encontrado
            objetoAtual.actualColor = "rgba(255,255,255,0.5)";
        }

        //Função Mouse - Movimentação
        addEventListener("mousemove", function(e){
            mouse.posX = e.clientX;
            mouse.posY = e.clientY;
            //console.log(mouse.posX, mouse.posY);

            //Edita o SQM clicado se o Mouse estiver clicado
            if(mouse.clicado == true) {
                editarSqms();
            }

        })
        //Função Mouse - Clique
        addEventListener("mousedown", function(e){
            mouse.clicado = true;
            
            //Edita o SQM clicado
            editarSqms();

            //Retornar o resultado o objeto encontrado
            //console.log(objetoAtual);

            //console.log(mapaPrincipal.matriz);
            //console.log("Clicou");
        })
        //Função Mouse - Soltou Clique
        addEventListener("mouseup", function(e){
            mouse.clicado = false;
            //console.log("Soltou");
        })

        

        //Instâncias
        let mapaPrincipal = new Mapa(ctx, defaultMapaPositionX, defaultMapaPositionY, defaultMapaSizeW, defaultMapaSizeH, totalSqmX, totalSqmY);
        let mouse = new Mouse();

        //Inicia o carregamento geral
        start();



    </script>
</body>
</html>